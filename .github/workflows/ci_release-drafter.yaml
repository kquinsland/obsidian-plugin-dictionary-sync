name: Release Notes Drafter

on:
    push:
        branches:
            - main

permissions:
    contents: write
    # Note: this is not enough!
    # Must _also_ toggle "Allow GitHub Actions to create and approve pull requests"
    # https://github.com/kquinsland/obsidian-plugin-dictionary-sync/settings/actions
    pull-requests: write
    issues: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        steps:
            - name: Release Please
              id: release
              uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
              with:
                  config-file: ci/release-please-config.json
                  manifest-file: ci/release-please-manifest.json
            # âœ” Successfully opened pull request: 19.

            - name: Checkout release PR branch
              if: ${{ steps.release.outputs.prs_created == 'true' }}
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  ref: ${{ fromJson(steps.release.outputs.pr).headBranchName || fromJson(steps.release.outputs.pr).head.ref }}
                  persist-credentials: false

            - name: Sync manifest.json and versions.json
              if: ${{ steps.release.outputs.prs_created == 'true' }}
              run: |
                  VERSION="$(node -p "require('./package.json').version")"
                  npm_package_version="$VERSION" node scripts/version-bump.mjs
                  if [ -z "$(git status --porcelain)" ]; then
                    echo "No version sync changes."
                    exit 0
                  fi
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add manifest.json versions.json
                  git commit -m "chore(release): sync manifest and versions"
                  git push
