name: Release Notes Drafter

on:
    push:
        branches:
            - main

permissions:
    contents: write
    # Note: this is not enough!
    # Must _also_ toggle "Allow GitHub Actions to create and approve pull requests"
    # https://github.com/kquinsland/obsidian-plugin-dictionary-sync/settings/actions
    pull-requests: write
    issues: write

jobs:
    release-please:
        runs-on: ubuntu-latest
        steps:
            - name: Release Please
              id: release
              uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
              with:
                  config-file: ci/release-please-config.json
                  manifest-file: ci/release-please-manifest.json
            # âœ” Successfully opened pull request: 19.

            - name: Checkout release PR branch
              if: ${{ steps.release.outputs.prs_created == 'true' }}
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  ref: ${{ fromJson(steps.release.outputs.pr).headBranchName || fromJson(steps.release.outputs.pr).head.ref }}
                  persist-credentials: true

            - name: Sync manifest.json and versions.json
              if: ${{ steps.release.outputs.prs_created == 'true' }}
              run: |
                  VERSION="$(node -p "require('./package.json').version")"
                  npm_package_version="$VERSION" node scripts/version-bump.mjs
                  if [ -z "$(git status --porcelain)" ]; then
                    echo "No version sync changes."
                    exit 0
                  fi
                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
                  git add manifest.json versions.json
                  git commit -m "chore(release): sync manifest and versions"
                  git push

            - name: Checkout release tag
              if: ${{ steps.release.outputs.release_created == 'true' }}
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  ref: ${{ steps.release.outputs.tag_name }}
                  fetch-depth: 1
                  # We are making no more git changes, clear creds to make zizmor happy
                  persist-credentials: false

            - name: Setup Node
              if: ${{ steps.release.outputs.release_created == 'true' }}
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
              with:
                  node-version: 24
                  package-manager-cache: false

            - name: Setup pnpm
              if: ${{ steps.release.outputs.release_created == 'true' }}
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
              with:
                  version: latest

            - name: Install deps
              if: ${{ steps.release.outputs.release_created == 'true' }}
              run: pnpm install --frozen-lockfile

            - name: Build
              if: ${{ steps.release.outputs.release_created == 'true' }}
              env:
                  PLUGIN_VERSION: ${{ steps.release.outputs.version }}
              run: pnpm build

            - name: Verify manifest version matches tag
              if: ${{ steps.release.outputs.release_created == 'true' }}
              run: |
                  TAG="${RELEASE_TAG}"
                  TAG="${TAG#v}"
                  MANIFEST_VERSION="$(node -p "require('./manifest.json').version")"
                  if [ "$TAG" != "$MANIFEST_VERSION" ]; then
                    echo "manifest.json version ($MANIFEST_VERSION) does not match tag ($TAG)"
                    exit 1
                  fi
              env:
                  RELEASE_TAG: ${{ steps.release.outputs.tag_name }}

            - name: Package release
              if: ${{ steps.release.outputs.release_created == 'true' }}
              run: |
                  zip -j "obsidian-dictionary-sync-${RELEASE_TAG}.zip" main.js manifest.json styles.css
              env:
                  RELEASE_TAG: ${{ steps.release.outputs.tag_name }}

            - name: Upload release assets
              if: ${{ steps.release.outputs.release_created == 'true' }}
              uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
              with:
                  tag_name: ${{ steps.release.outputs.tag_name }}
                  files: |
                      main.js
                      manifest.json
                      styles.css
                      obsidian-dictionary-sync-${{ steps.release.outputs.tag_name }}.zip
